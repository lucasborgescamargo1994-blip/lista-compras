<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lista Inteligente - Free</title>
    
    <script src="cordova.js"></script>

    <style>
        :root { --primary: #2e7d32; --secondary: #1565c0; --bg: #f8f9fa; --white: #ffffff; --danger: #d32f2f; --whatsapp: #25d366; --gold: #fbc02d; }
        
        body { 
            font-family: -apple-system, sans-serif; 
            margin: 0; 
            background: var(--bg); 
            /* Espa√ßo reservado para o Banner do AdMob no topo (aprox 50px a 60px) */
            padding-top: 60px; 
            padding-bottom: 180px; 
            color: #333; 
        }
        
        .header { background: var(--primary); color: white; padding: 12px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .container { padding: 10px 15px; max-width: 600px; margin: auto; }
        .card { background: var(--white); border-radius: 12px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 12px; }

        label { font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase; margin-bottom: 5px; display: block; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; margin-bottom: 10px; outline: none; }
        
        .btn-add { width: 100%; background: var(--primary); color: white; border: none; padding: 16px; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; }

        .item-row { background: var(--white); padding: 12px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; }
        .item-info b { display: block; font-size: 1.05em; text-transform: capitalize; }
        .item-info small { display: block; color: var(--danger); font-size: 0.78em; margin-top: 3px; font-weight: 600; }
        
        .price-box { display: flex; align-items: center; background: #e8f5e9; padding: 5px 10px; border-radius: 6px; width: 90px; border: 1px solid #c8e6c9; }
        .input-price { background: transparent; border: none; width: 100%; text-align: right; font-weight: bold; color: var(--primary); outline: none; }

        .footer { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; padding: 12px 20px; display: flex; flex-direction: column; gap: 8px; box-sizing: border-box; z-index: 100; }
        .total-val { font-size: 1.6em; font-weight: bold; color: var(--primary); }
        
        .actions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-finish { background: var(--secondary); color: white; border: none; padding: 14px; border-radius: 8px; font-weight: bold; }
        .btn-share { background: var(--whatsapp); color: white; border: none; padding: 14px; border-radius: 8px; font-weight: bold; }

        .btn-go-pro { background: #fff8e1; color: #b7950b; border: 2px solid var(--gold); padding: 12px; border-radius: 8px; text-decoration: none; font-weight: bold; display: block; text-align: center; margin-bottom: 20px; }

        #modal-hist { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 200; overflow-y: auto; }
        .hist-header { padding: 15px; background: #f5f5f5; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0; font-size: 1.1em;">üõí Lista Inteligente (Free)</h2>
</div>

<div class="container">
    <div class="card">
        <label>O que voc√™ est√° pegando?</label>
        <input type="text" id="prod-nome" placeholder="Ex: Arroz, Feij√£o..." autocomplete="off">
        <button type="button" class="btn-add" onclick="adicionarItem()">ADICIONAR</button>
    </div>

    <div class="card" style="background: #e3f2fd; border: 1px dashed #90caf9;">
        <label style="color: var(--secondary);">Local da Compra</label>
        <input type="text" id="mercado-nome" placeholder="Nome do Mercado" style="margin-bottom:0;">
    </div>

    <div id="lista-corpo"></div>
</div>

<div class="footer">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <button onclick="abrirHist()" style="padding: 10px; border-radius: 8px; border: 1px solid #ccc; background: #f5f5f5; font-weight: bold;">üìú HIST√ìRICO</button>
        <div class="total-val" id="total-txt">R$ 0,00</div>
    </div>
    <div class="actions-grid">
        <button class="btn-share" onclick="enviarWhatsApp()">üì§ ENVIAR</button>
        <button class="btn-finish" onclick="finalizarCompra()">‚úÖ FINALIZAR</button>
    </div>
</div>

<div id="modal-hist">
    <div class="hist-header">
        <h3 style="margin:0">üìú Hist√≥rico</h3>
        <button onclick="fecharHist()" style="padding: 8px 15px; border-radius: 5px; border: 1px solid #999; background: #fff;">VOLTAR</button>
    </div>
    <div id="hist-lista" style="padding: 15px;"></div>
</div>

<script>
    let listaItens = [];
    let historicoCompras = JSON.parse(localStorage.getItem('minhasComprasHist')) || [];

    // --- L√ìGICA DO ADMOB ---
    document.addEventListener('deviceready', function() {
        if (typeof admob !== 'undefined') {
            admob.banner.config({
                id: 'ca-app-pub-3940256099942544/6300978111', // ID DE TESTE DO GOOGLE (Mude para o seu depois)
                bannerAtTop: true,
                overlap: false,
                isTesting: true // Mantenha TRUE at√© o app ir para a loja
            });
            admob.banner.prepare();
        }
        verificarListaRecebida();
    }, false);

    function buscarPrecoAntigo(nomeProduto) {
        const termo = nomeProduto.toLowerCase().trim();
        for (let i = historicoCompras.length - 1; i >= 0; i--) {
            const compra = historicoCompras[i];
            for (let item of compra.itens) {
                if (item.nome.toLowerCase().trim() === termo) return { preco: item.preco, mercado: compra.mercado };
            }
        }
        return null;
    }

    function verificarListaRecebida() {
        const urlParams = new URLSearchParams(window.location.search);
        let dadosBase64 = urlParams.get('importar');
        
        if (dadosBase64) {
            importarDados(dadosBase64);
        }
    }

    function importarDados(dadosBase64) {
        if (confirm("Deseja carregar a lista recebida?")) {
            try {
                const dadosDecodificados = JSON.parse(atob(dadosBase64));
                listaItens = dadosDecodificados.map(it => {
                    const ref = buscarPrecoAntigo(it.nome); 
                    return {
                        id: Date.now() + Math.random(),
                        nome: it.nome,
                        preco: "",
                        dica: ref ? `Antigo: R$ ${parseFloat(ref.preco).toFixed(2).replace('.',',')} (${ref.mercado})` : ""
                    };
                });
                renderizar();
            } catch (e) { alert("Erro na importa√ß√£o."); }
        }
    }

    function adicionarItem() {
        const input = document.getElementById('prod-nome');
        const nome = input.value.trim();
        if(!nome) return;
        const ref = buscarPrecoAntigo(nome);
        listaItens.unshift({ 
            id: Date.now(), 
            nome: nome, 
            preco: "", 
            dica: ref ? `Antigo: R$ ${parseFloat(ref.preco).toFixed(2).replace('.',',')} (${ref.mercado})` : "" 
        });
        input.value = "";
        renderizar();
    }

    function renderizar() {
        let html = "";
        listaItens.forEach(item => {
            html += `<div class="item-row">
                <div class="item-info"><b>${item.nome}</b>${item.dica ? `<small>${item.dica}</small>` : ''}</div>
                <div class="price-box"><span>R$</span><input type="tel" class="input-price" value="${item.preco}" oninput="mudarPreco(${item.id}, this.value)"></div>
                <button class="btn-del" onclick="remover(${item.id})">√ó</button>
            </div>`;
        });
        document.getElementById('lista-corpo').innerHTML = html;
        atualizarTotal();
    }

    function mudarPreco(id, valor) {
        listaItens.forEach(it => { if(it.id === id) it.preco = valor.replace(',', '.'); });
        atualizarTotal();
    }

    function remover(id) {
        listaItens = listaItens.filter(it => it.id !== id);
        renderizar();
    }

    function atualizarTotal() {
        const total = listaItens.reduce((acc, it) => acc + (parseFloat(it.preco) || 0), 0);
        document.getElementById('total-txt').innerText = "R$ " + total.toFixed(2).replace('.', ',');
    }

    function enviarWhatsApp() {
        if (listaItens.length === 0) return;
        const mercado = document.getElementById('mercado-nome').value.trim() || "Mercado";
        let itensTexto = "";
        listaItens.forEach(it => { itensTexto += `‚Ä¢ ${it.nome}\n`; });
        
        const dadosCompactados = btoa(JSON.stringify(listaItens));
        // Link configurado para o Esquema do App e Fallback Web
        const linkApp = `https://seu-usuario.github.io/lista/?importar=${dadosCompactados}`;
        
        const textoFinal = `üõí *LISTA DE COMPRAS - ${mercado.toUpperCase()}*\n\n${itensTexto}\nüëá *ABRIR NO APP:* \n${linkApp}`;
        window.open("https://api.whatsapp.com/send?text=" + encodeURIComponent(textoFinal), '_blank');
    }

    function finalizarCompra() {
        const mercado = document.getElementById('mercado-nome').value.trim();
        if(!mercado || listaItens.length === 0) { alert("Preencha o mercado e a lista!"); return; }
        
        historicoCompras.push({
            mercado: mercado,
            data: new Date().toLocaleDateString() + " " + new Date().toLocaleTimeString().slice(0,5),
            itens: JSON.parse(JSON.stringify(listaItens)),
            total: listaItens.reduce((acc, it) => acc + (parseFloat(it.preco) || 0), 0)
        });
        
        localStorage.setItem('minhasComprasHist', JSON.stringify(historicoCompras));
        listaItens = [];
        document.getElementById('mercado-nome').value = "";
        renderizar();
        alert("Compra finalizada!");
    }

 function abrirHist() {
    document.getElementById('modal-hist').style.display = 'block';
    const container = document.getElementById('hist-lista');
    
    // 1. Bot√£o PRO no topo
    let html = `<a href="LINK_PRO_AQUI" class="btn-go-pro">‚ú® REMOVER AN√öNCIOS (VERS√ÉO PRO)</a>`;
    
    if (historicoCompras.length === 0) {
        html += "<p style='text-align:center; color:#999; margin-top:20px;'>Nenhuma compra salva no hist√≥rico.</p>";
    } else {
        // 2. Bot√£o de Limpar (Aparece apenas se houver hist√≥rico)
        html += `
            <button onclick="limparHistorico()" style="
                background: #fff; 
                color: var(--danger); 
                border: 1px solid var(--danger); 
                padding: 10px; 
                border-radius: 8px; 
                width: 100%; 
                margin-bottom: 20px; 
                font-weight: bold; 
                cursor: pointer;
            ">üóëÔ∏è APAGAR TODO HIST√ìRICO</button>
        `;

        // 3. Listagem dos Cards
        for(let i = historicoCompras.length - 1; i >= 0; i--) {
            const c = historicoCompras[i];
            html += `
                <div class="card" style="margin-bottom: 15px; border: 1px solid #eee;">
                    <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:8px;">
                        <strong>${c.mercado}</strong>
                        <small style="color:#888;">${c.data}</small>
                    </div>`;
            
            c.itens.forEach(it => {
                html += `
                    <div style="display:flex; justify-content:space-between; font-size:14px; margin-bottom:3px;">
                        <span>${it.nome}</span>
                        <b style="color:#555;">R$ ${parseFloat(it.preco || 0).toFixed(2).replace('.',',')}</b>
                    </div>`;
            });

            html += `
                    <div style="text-align:right; margin-top:10px; padding-top:5px; border-top:1px dashed #eee; color:var(--primary); font-weight:bold; font-size:1.1em;">
                        TOTAL: R$ ${c.total.toFixed(2).replace('.', ',')}
                    </div>
                </div>`;
        }
    }
    container.innerHTML = html;
}

// Certifique-se de que a fun√ß√£o de limpar tamb√©m existe no seu script:
function limparHistorico() {
    if(confirm("Tem certeza que deseja apagar permanentemente todo o hist√≥rico de compras?")) {
        historicoCompras = [];
        localStorage.removeItem('minhasComprasHist');
        abrirHist(); // Recarrega a tela do hist√≥rico
    }
}
    function fecharHist() { document.getElementById('modal-hist').style.display = 'none'; }
</script>
</body>
</html>
