<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minhas Compras Inteligente</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="favicon.ico">
    
    <style>
        :root { --primary: #2e7d32; --secondary: #1565c0; --bg: #f8f9fa; --white: #ffffff; --danger: #d32f2f; --whatsapp: #25d366; }
        body { font-family: -apple-system, sans-serif; margin: 0; background: var(--bg); padding-bottom: 165px; color: #333; }
        
        .header { background: var(--primary); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .container { padding: 15px; max-width: 600px; margin: auto; }
        .card { background: var(--white); border-radius: 12px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 15px; }

        label { font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase; margin-bottom: 5px; display: block; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; margin-bottom: 10px; outline: none; }
        
        .btn-add { width: 100%; background: var(--primary); color: white; border: none; padding: 16px; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; }

        .mercado-box { background: #e3f2fd; border: 1px dashed #90caf9; }

        /* Lista de Itens Atuais */
        .item-row { background: var(--white); padding: 12px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; }
        .item-info { flex: 1; padding-right: 5px; }
        .item-info b { display: block; font-size: 1.05em; text-transform: capitalize; color: #1a1a1a; }
        .item-info small { display: block; color: var(--danger); font-size: 0.75em; margin-top: 2px; font-weight: 500; }
        
        .price-box { display: flex; align-items: center; background: #e8f5e9; padding: 5px 10px; border-radius: 6px; width: 95px; border: 1px solid #c8e6c9; }
        .price-box span { color: var(--primary); font-weight: bold; margin-right: 3px; font-size: 0.9em; }
        .input-price { background: transparent; border: none; width: 100%; text-align: right; font-weight: bold; color: var(--primary); margin-bottom: 0 !important; padding: 0; font-size: 1.1em; outline: none; }

        .btn-del { background: #ffebee; color: var(--danger); border: none; width: 32px; height: 32px; border-radius: 50%; margin-left: 10px; font-weight: bold; }

        /* Rodap√© e Bot√µes */
        .footer { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; padding: 12px 20px; display: flex; flex-direction: column; gap: 8px; box-sizing: border-box; z-index: 100; }
        .footer-top { display: flex; justify-content: space-between; align-items: center; }
        .total-val { font-size: 1.6em; font-weight: bold; color: var(--primary); }
        
        .actions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-finish { background: var(--secondary); color: white; border: none; padding: 14px; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer; }
        .btn-share { background: var(--whatsapp); color: white; border: none; padding: 14px; border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer; }

        /* Modal Hist√≥rico Detalhado */
        #modal-hist { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 200; overflow-y: auto; }
        .hist-header { padding: 15px; background: #f5f5f5; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; border-bottom: 1px solid #ddd; z-index: 10; }
        .hist-card { background: #fff; border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .hist-item-row { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dotted #eee; font-size: 14px; }
        .hist-item-name { color: #555; text-transform: capitalize; }
        .hist-item-price { font-weight: 600; color: #333; }
        .btn-clear { background: var(--danger); color: white; border: none; padding: 12px; border-radius: 8px; font-weight: bold; width: 100%; margin-bottom: 20px; }
    </style>
</head>
<body onload="verificarListaRecebida()">

<div class="header">
    <h2 style="margin:0; font-size: 1.2em;">üõí Lista de Compras</h2>
</div>

<div class="container">
    <div class="card">
        <label>O que voc√™ est√° pegando?</label>
        <input type="text" id="prod-nome" placeholder="Ex: Arroz 5kg, Feij√£o, etc.">
        <button type="button" class="btn-add" onclick="adicionarItem()">ADICIONAR √Ä LISTA</button>
    </div>

    <div class="card mercado-box">
        <label style="color: var(--secondary);">Local da Compra (Mercado)</label>
        <input type="text" id="mercado-nome" placeholder="Ex: Supermercado Central" style="margin-bottom:0; border-color: #90caf9;">
    </div>

    <div id="lista-corpo"></div>
</div>

<div class="footer">
    <div class="footer-top">
        <button onclick="abrirHist()" style="padding: 10px 14px; border-radius: 8px; border: 1px solid #ccc; background: #f5f5f5; font-weight: bold; font-size: 13px;">üìú HIST√ìRICO</button>
        <div class="total-val" id="total-txt">R$ 0,00</div>
    </div>
    <div class="actions-grid">
        <button class="btn-share" onclick="enviarWhatsApp()">üì§ ENVIAR LISTA</button>
        <button class="btn-finish" onclick="finalizarCompra()">‚úÖ FINALIZAR</button>
    </div>
</div>

<div id="modal-hist">
    <div class="hist-header">
        <h3 style="margin:0">üìú Hist√≥rico de Compras</h3>
        <button onclick="fecharHist()" style="padding: 8px 15px; border-radius: 5px; border: 1px solid #999; background: #fff; font-weight: bold;">VOLTAR</button>
    </div>
    <div id="hist-lista" style="padding: 15px;"></div>
</div>

<script>
    let listaItens = [];
    let historicoCompras = JSON.parse(localStorage.getItem('minhasComprasHist')) || [];

    // 1. IMPORTAR LISTA VIA LINK
    function verificarListaRecebida() {
        const urlParams = new URLSearchParams(window.location.search);
        const dadosBase64 = urlParams.get('importar');
        if (dadosBase64) {
            if (confirm("Voc√™ recebeu uma nova lista de compras! Deseja carregar os itens agora?")) {
                try {
                    const dadosDecodificados = JSON.parse(atob(dadosBase64));
                    listaItens = dadosDecodificados.map(it => {
                        // Ao importar, limpamos os pre√ßos e buscamos o hist√≥rico do novo usu√°rio
                        const ref = buscarPrecoAntigo(it.nome);
                        return {
                            id: Date.now() + Math.random(),
                            nome: it.nome,
                            preco: "",
                            dica: ref ? `Antigo: R$ ${parseFloat(ref.preco).toFixed(2).replace('.',',')} (${ref.mercado})` : ""
                        };
                    });
                    renderizar();
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (e) { alert("Erro ao importar lista."); }
            }
        }
    }

    // 2. BUSCAR PRE√áO NO HIST√ìRICO LOCAL
    function buscarPrecoAntigo(nomeProduto) {
        const termo = nomeProduto.toLowerCase().trim();
        for (let i = historicoCompras.length - 1; i >= 0; i--) {
            const compra = historicoCompras[i];
            for (let j = 0; j < compra.itens.length; j++) {
                if (compra.itens[j].nome.toLowerCase().trim() === termo) {
                    return { preco: compra.itens[j].preco, mercado: compra.mercado };
                }
            }
        }
        return null;
    }

    // 3. ADICIONAR E RENDERIZAR
    function adicionarItem() {
        const input = document.getElementById('prod-nome');
        const nome = input.value.trim();
        if(!nome) return;

        const ref = buscarPrecoAntigo(nome);
        const dicaTexto = ref ? `Antigo: R$ ${parseFloat(ref.preco).toFixed(2).replace('.',',')} (${ref.mercado})` : "";

        listaItens.unshift({ id: Date.now(), nome: nome, preco: "", dica: dicaTexto });
        input.value = "";
        renderizar();
    }

    function renderizar() {
        let html = "";
        listaItens.forEach(item => {
            html += `
            <div class="item-row">
                <div class="item-info">
                    <b>${item.nome}</b>
                    ${item.dica ? `<small>${item.dica}</small>` : ''}
                </div>
                <div class="price-box">
                    <span>R$</span>
                    <input type="tel" class="input-price" value="${item.preco}" placeholder="0,00" 
                    oninput="mudarPreco(${item.id}, this.value)">
                </div>
                <button class="btn-del" onclick="remover(${item.id})">√ó</button>
            </div>`;
        });
        document.getElementById('lista-corpo').innerHTML = html;
        atualizarTotal();
    }

    function mudarPreco(id, valor) {
        listaItens.forEach(it => { if(it.id === id) it.preco = valor.replace(',', '.'); });
        atualizarTotal();
    }

    function remover(id) {
        listaItens = listaItens.filter(it => it.id !== id);
        renderizar();
    }

    function atualizarTotal() {
        const total = listaItens.reduce((acc, it) => acc + (parseFloat(it.preco) || 0), 0);
        document.getElementById('total-txt').innerText = "R$ " + total.toFixed(2).replace('.', ',');
    }

    // 4. COMPARTILHAR WHATSAPP
    function enviarWhatsApp() {
        if (listaItens.length === 0) { alert("Sua lista est√° vazia!"); return; }
        const mercado = document.getElementById('mercado-nome').value.trim() || "Mercado";
        
        let texto = `üõí *LISTA DE COMPRAS - ${mercado.toUpperCase()}*\n\n`;
        listaItens.forEach(it => { texto += `‚Ä¢ ${it.nome}\n`; });

        const baseUrl = window.location.href.split('?')[0];
        const dadosCompactados = btoa(JSON.stringify(listaItens));
        const linkApp = `${baseUrl}?importar=${dadosCompactados}`;
        
        texto += `\nüëá *CLIQUE NO LINK ABAIXO PARA ABRIR NO APP:* \n${linkApp}`;

        window.open("https://api.whatsapp.com/send?text=" + encodeURIComponent(texto), '_blank');
    }

    // 5. FINALIZAR E HIST√ìRICO
    function finalizarCompra() {
        const mercado = document.getElementById('mercado-nome').value.trim();
        if(!mercado) { alert("Preencha o nome do mercado!"); return; }
        if(listaItens.length === 0) { alert("Sua lista est√° vazia!"); return; }

        const total = listaItens.reduce((acc, it) => acc + (parseFloat(it.preco) || 0), 0);
        historicoCompras.push({
            mercado: mercado,
            data: new Date().toLocaleDateString() + " " + new Date().toLocaleTimeString().slice(0,5),
            itens: JSON.parse(JSON.stringify(listaItens)),
            total: total
        });

        localStorage.setItem('minhasComprasHist', JSON.stringify(historicoCompras));
        listaItens = [];
        document.getElementById('mercado-nome').value = "";
        renderizar();
        alert("Compra finalizada e salva no hist√≥rico!");
    }

    function abrirHist() {
        document.getElementById('modal-hist').style.display = 'block';
        const container = document.getElementById('hist-lista');
        if (historicoCompras.length === 0) {
            container.innerHTML = "<p style='text-align:center; color:#999; margin-top:50px;'>Hist√≥rico vazio.</p>";
            return;
        }

        let html = '<button class="btn-clear" onclick="limparHistorico()">‚ö†Ô∏è APAGAR TODO O HIST√ìRICO</button>';
        for(let i = historicoCompras.length - 1; i >= 0; i--) {
            const c = historicoCompras[i];
            html += `<div class="hist-card">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:2px solid #f5f5f5; padding-bottom:5px;">
                    <strong style="color:var(--secondary);">${c.mercado}</strong>
                    <span style="color:#888; font-size:11px;">${c.data}</span>
                </div>`;
            c.itens.forEach(it => {
                html += `<div class="hist-item-row">
                    <span class="hist-item-name">${it.nome}</span>
                    <span class="hist-item-price">R$ ${parseFloat(it.preco || 0).toFixed(2).replace('.',',')}</span>
                </div>`;
            });
            html += `<div style="text-align:right; margin-top:10px; padding-top:8px; color:var(--primary); font-weight:bold;">
                TOTAL: R$ ${c.total.toFixed(2).replace('.', ',')}
            </div></div>`;
        }
        container.innerHTML = html;
    }

    function fecharHist() { document.getElementById('modal-hist').style.display = 'none'; }
    function limparHistorico() { if(confirm("Deseja apagar permanentemente todo o hist√≥rico?")) { historicoCompras = []; localStorage.removeItem('minhasComprasHist'); abrirHist(); } }
</script>
</body>
</html>
