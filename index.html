<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lista Inteligente - Free</title>
    
    <script src="cordova.js"></script>

    <style>
        :root { --primary: #2e7d32; --secondary: #1565c0; --bg: #f8f9fa; --white: #ffffff; --danger: #d32f2f; --whatsapp: #25d366; --gold: #fbc02d; }
        
        body { 
            font-family: -apple-system, sans-serif; 
            margin: 0; 
            background: var(--bg); 
            padding-top: 65px; /* Espa√ßo para o Banner AdMob */
            padding-bottom: 180px; 
            color: #333; 
        }
        
        .header { background: var(--primary); color: white; padding: 12px; text-align: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .container { padding: 10px 15px; max-width: 600px; margin: auto; }
        .card { background: var(--white); border-radius: 12px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 12px; position: relative; }

        label { font-size: 11px; font-weight: bold; color: #888; text-transform: uppercase; margin-bottom: 5px; display: block; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; margin-bottom: 10px; outline: none; }
        
        .btn-add { width: 100%; background: var(--primary); color: white; border: none; padding: 16px; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; }

        .item-row { background: var(--white); padding: 12px; border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; }
        .item-info b { display: block; font-size: 1.05em; text-transform: capitalize; }
        .item-info small { display: block; color: var(--danger); font-size: 0.78em; margin-top: 3px; font-weight: 600; }
        
        .price-box { display: flex; align-items: center; background: #e8f5e9; padding: 5px 10px; border-radius: 6px; width: 95px; border: 1px solid #c8e6c9; }
        .input-price { background: transparent; border: none; width: 100%; text-align: right; font-weight: bold; color: var(--primary); outline: none; font-size: 16px; }

        .btn-del { background: none; border: none; color: #ccc; font-size: 22px; margin-left: 10px; cursor: pointer; }

        .footer { position: fixed; bottom: 0; width: 100%; background: white; border-top: 1px solid #ddd; padding: 12px 20px; display: flex; flex-direction: column; gap: 8px; box-sizing: border-box; z-index: 100; }
        .total-val { font-size: 1.6em; font-weight: bold; color: var(--primary); }
        
        .actions-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn-finish { background: var(--secondary); color: white; border: none; padding: 14px; border-radius: 8px; font-weight: bold; font-size: 14px; }
        .btn-share { background: var(--whatsapp); color: white; border: none; padding: 14px; border-radius: 8px; font-weight: bold; font-size: 14px; }

        .btn-go-pro { background: #fff8e1; color: #b7950b; border: 2px solid var(--gold); padding: 12px; border-radius: 8px; text-decoration: none; font-weight: bold; display: block; text-align: center; margin-bottom: 15px; font-size: 14px; }

        #modal-hist { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 200; overflow-y: auto; }
        .hist-header { padding: 15px; background: #f5f5f5; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 210; }
        
        .btn-x-hist { position: absolute; top: 8px; right: 8px; background: #fdf2f2; color: var(--danger); border: none; width: 28px; height: 28px; border-radius: 50%; font-weight: bold; font-size: 18px; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div class="header">
    <h2 style="margin:0; font-size: 1.1em;">üõí Minha Lista Inteligente</h2>
</div>

<div class="container">
    <div class="card">
        <label>O que voc√™ est√° pegando?</label>
        <input type="text" id="prod-nome" placeholder="Ex: Arroz, Feij√£o..." autocomplete="off">
        <button type="button" class="btn-add" onclick="adicionarItem()">ADICIONAR NA LISTA</button>
    </div>

    <div class="card" style="background: #e3f2fd; border: 1px dashed #90caf9;">
        <label style="color: var(--secondary);">Mercado / Estabelecimento</label>
        <input type="text" id="mercado-nome" placeholder="Ex: Supermercado X" style="margin-bottom:0;">
    </div>

    <div id="lista-corpo"></div>
</div>

<div class="footer">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <button onclick="abrirHist()" style="padding: 10px 15px; border-radius: 8px; border: 1px solid #ccc; background: #f5f5f5; font-weight: bold; font-size: 12px;">üìú HIST√ìRICO</button>
        <div class="total-val" id="total-txt">R$ 0,00</div>
    </div>
    <div class="actions-grid">
        <button class="btn-share" onclick="enviarWhatsApp()">üì§ ENVIAR LISTA</button>
        <button class="btn-finish" onclick="finalizarCompra()">‚úÖ FINALIZAR</button>
    </div>
</div>

<div id="modal-hist">
    <div class="hist-header">
        <h3 style="margin:0">üìú Hist√≥rico de Compras</h3>
        <button onclick="fecharHist()" style="padding: 8px 15px; border-radius: 8px; border: 1px solid #999; background: #fff; font-weight: bold;">FECHAR</button>
    </div>
    <div id="hist-lista" style="padding: 15px;"></div>
</div>

<script>
    let listaItens = [];
    let historicoCompras = JSON.parse(localStorage.getItem('minhasComprasHist')) || [];

    // INICIALIZA√á√ÉO CORDOVA/ADMOB
    document.addEventListener('deviceready', function() {
        if (typeof admob !== 'undefined') {
            admob.banner.config({
                id: 'ca-app-pub-3940256099942544/6300978111', // ID DE TESTE
                bannerAtTop: true,
                overlap: false,
                isTesting: true 
            });
            admob.banner.prepare();
        }
        verificarListaRecebida();
    }, false);

    function buscarPrecoAntigo(nomeProduto) {
        const termo = nomeProduto.toLowerCase().trim();
        for (let i = historicoCompras.length - 1; i >= 0; i--) {
            const compra = historicoCompras[i];
            for (let item of compra.itens) {
                if (item.nome.toLowerCase().trim() === termo) return { preco: item.preco, mercado: compra.mercado };
            }
        }
        return null;
    }

    function verificarListaRecebida() {
        const urlParams = new URLSearchParams(window.location.search);
        let dadosBase64 = urlParams.get('importar');
        if (dadosBase64) importarDados(dadosBase64);
    }

    function importarDados(dadosBase64) {
        if (confirm("Deseja carregar a lista recebida via WhatsApp?")) {
            try {
                const dadosDecodificados = JSON.parse(atob(dadosBase64));
                listaItens = dadosDecodificados.map(it => {
                    const ref = buscarPrecoAntigo(it.nome); 
                    return {
                        id: Date.now() + Math.random(),
                        nome: it.nome,
                        preco: "",
                        dica: ref ? `Antigo: R$ ${parseFloat(ref.preco).toFixed(2).replace('.',',')} (${ref.mercado})` : ""
                    };
                });
                renderizar();
            } catch (e) { alert("Erro ao importar lista."); }
        }
    }

    function adicionarItem() {
        const input = document.getElementById('prod-nome');
        const nome = input.value.trim();
        if(!nome) return;
        const ref = buscarPrecoAntigo(nome);
        listaItens.unshift({ 
            id: Date.now(), 
            nome: nome, 
            preco: "", 
            dica: ref ? `Antigo: R$ ${parseFloat(ref.preco).toFixed(2).replace('.',',')} (${ref.mercado})` : "" 
        });
        input.value = "";
        renderizar();
    }

    function renderizar() {
        let html = "";
        listaItens.forEach(item => {
            html += `<div class="item-row">
                <div class="item-info"><b>${item.nome}</b>${item.dica ? `<small>${item.dica}</small>` : ''}</div>
                <div class="price-box"><span>R$</span><input type="tel" class="input-price" value="${item.preco}" oninput="mudarPreco(${item.id}, this.value)"></div>
                <button class="btn-del" onclick="remover(${item.id})">√ó</button>
            </div>`;
        });
        document.getElementById('lista-corpo').innerHTML = html;
        atualizarTotal();
    }

    function mudarPreco(id, valor) {
        listaItens.forEach(it => { if(it.id === id) it.preco = valor.replace(',', '.'); });
        atualizarTotal();
    }

    function remover(id) {
        listaItens = listaItens.filter(it => it.id !== id);
        renderizar();
    }

    function atualizarTotal() {
        const total = listaItens.reduce((acc, it) => acc + (parseFloat(it.preco) || 0), 0);
        document.getElementById('total-txt').innerText = "R$ " + total.toFixed(2).replace('.', ',');
    }

    function enviarWhatsApp() {
        if (listaItens.length === 0) { alert("Adicione itens antes de enviar!"); return; }
        const mercado = document.getElementById('mercado-nome').value.trim() || "Mercado";
        let itensTexto = "";
        listaItens.forEach(it => { itensTexto += `‚Ä¢ ${it.nome}\n`; });
        
        const dadosBase64 = btoa(JSON.stringify(listaItens));
        const linkApp = `https://seu-usuario.github.io/lista/?importar=${dadosBase64}`;
        
        const textoFinal = `üõí *LISTA DE COMPRAS - ${mercado.toUpperCase()}*\n\n${itensTexto}\nüëá *PARA IMPORTAR NO APP:* \n${linkApp}`;
        window.open("https://api.whatsapp.com/send?text=" + encodeURIComponent(textoFinal), '_blank');
    }

    function finalizarCompra() {
        const mercado = document.getElementById('mercado-nome').value.trim();
        if(!mercado || listaItens.length === 0) { alert("Informe o mercado e tenha ao menos 1 item!"); return; }
        
        historicoCompras.push({
            mercado: mercado,
            data: new Date().toLocaleDateString() + " " + new Date().toLocaleTimeString().slice(0,5),
            itens: JSON.parse(JSON.stringify(listaItens)),
            total: listaItens.reduce((acc, it) => acc + (parseFloat(it.preco) || 0), 0)
        });
        
        localStorage.setItem('minhasComprasHist', JSON.stringify(historicoCompras));
        listaItens = [];
        document.getElementById('mercado-nome').value = "";
        renderizar();
        alert("Compra salva no hist√≥rico!");
    }

    function abrirHist() {
        document.getElementById('modal-hist').style.display = 'block';
        const container = document.getElementById('hist-lista');
        
        let html = `<a href="#" onclick="alert('Link da Play Store PRO')" class="btn-go-pro">‚ú® REMOVER AN√öNCIOS (VERS√ÉO PRO)</a>`;
        
        if (historicoCompras.length === 0) {
            html += "<p style='text-align:center; color:#999; margin-top:30px;'>Seu hist√≥rico est√° vazio.</p>";
        } else {
            html += `<button onclick="limparHistoricoTudo()" style="background:none; color:var(--danger); border:none; width:100%; margin-bottom:20px; font-size:12px; font-weight:bold; text-decoration:underline; cursor:pointer;">üóëÔ∏è APAGAR TODO O HIST√ìRICO</button>`;

            for(let i = historicoCompras.length - 1; i >= 0; i--) {
                const c = historicoCompras[i];
                html += `
                    <div class="card" style="border: 1px solid #eee;">
                        <button class="btn-x-hist" onclick="excluirCompraIndividual(${i})">√ó</button>
                        <div style="display:flex; justify-content:space-between; border-bottom:1px solid #eee; padding-bottom:5px; margin-bottom:8px; padding-right:30px;">
                            <strong>${c.mercado}</strong>
                            <small style="color:#888;">${c.data}</small>
                        </div>`;
                c.itens.forEach(it => {
                    html += `<div style="display:flex; justify-content:space-between; font-size:13px; margin-bottom:2px;">
                        <span>${it.nome}</span>
                        <b>R$ ${parseFloat(it.preco || 0).toFixed(2).replace('.',',')}</b>
                    </div>`;
                });
                html += `<div style="text-align:right; margin-top:8px; padding-top:5px; border-top:1px dashed #eee; color:var(--primary); font-weight:bold;">TOTAL: R$ ${c.total.toFixed(2).replace('.', ',')}</div></div>`;
            }
        }
        container.innerHTML = html;
    }

    function excluirCompraIndividual(index) {
        if(confirm("Deseja excluir esta lista espec√≠fica?")) {
            historicoCompras.splice(index, 1);
            localStorage.setItem('minhasComprasHist', JSON.stringify(historicoCompras));
            abrirHist();
        }
    }

    function limparHistoricoTudo() {
        if(confirm("Isso apagar√° todas as compras salvas. Tem certeza?")) {
            historicoCompras = [];
            localStorage.removeItem('minhasComprasHist');
            abrirHist();
        }
    }

    function fecharHist() { document.getElementById('modal-hist').style.display = 'none'; }
</script>
</body>
</html>
